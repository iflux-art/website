---
title: 部署与构建指南
description: 项目构建和部署的详细指南
date: 2025-08-29
category: 开发指南
tags:
  - 部署
  - 构建
  - CI/CD
---

# 部署与构建指南

本文档详细介绍如何构建和部署斐流艺创项目，包括本地构建、生产部署和持续集成配置。

## 构建流程

### 1. 构建命令

项目提供了多种构建相关的命令：

```bash
# 构建生产版本
pnpm build

# 清理构建文件
pnpm clean

# 构建并预览生产版本
pnpm preview

# 启动生产服务器
pnpm start
```

### 2. 构建过程

Next.js 构建过程包括以下步骤：

1. **代码编译**: TypeScript 代码编译为 JavaScript
2. **依赖分析**: 分析项目依赖关系
3. **代码分割**: 将代码分割为多个 chunks 以优化加载
4. **静态生成**: 为静态页面生成 HTML 文件
5. **服务端渲染**: 为动态页面准备 SSR 函数
6. **资源优化**: 压缩和优化图片、CSS、JavaScript 文件
7. **输出生成**: 生成 `.next` 目录包含所有构建产物

### 3. 构建配置

项目在 [next.config.mjs](file://c:\project\official\next.config.mjs) 中配置了以下构建选项：

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 启用详细日志
  logging: {
    level: "verbose",
  },
  
  // 支持的页面扩展名
  pageExtensions: ["js", "jsx", "ts", "tsx", "md", "mdx"],

  // TypeScript 错误检查
  typescript: {
    ignoreBuildErrors: false,
  },

  // 实验性功能
  experimental: {
    // 优化页面加载
    optimisticClientCache: true,
  },

  // 图片优化配置
  images: {
    formats: ["image/avif", "image/webp"],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    minimumCacheTTL: 60 * 60 * 24, // 24 小时
    remotePatterns: [
      {
        protocol: "https",
        hostname: "**",
      },
    ],
    dangerouslyAllowSVG: true,
    contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;",
  },

  // 启用压缩
  compress: true,

  // 强制静态生成配置
  trailingSlash: true,

  // Webpack 配置
  webpack: (config, { isServer }) => {
    if (isServer) {
      // 排除大文件从服务端包中
      config.externals = config.externals || [];
      config.externals.push({
        "src/config/links/items.json": "commonjs src/config/links/items.json",
        "src/config/links/categories.json": "commonjs src/config/links/categories.json",
      });
    }
    return config;
  },
};

export default nextConfig;
```

## 本地构建与预览

### 1. 构建生产版本

```bash
# 构建生产版本
pnpm build
```

构建完成后，会在项目根目录生成 `.next` 目录，包含所有构建产物。

### 2. 预览生产版本

```bash
# 构建并预览生产版本
pnpm preview
```

该命令会先执行构建，然后启动生产服务器，您可以在 [http://localhost:3000](http://localhost:3000) 预览构建结果。

### 3. 启动生产服务器

```bash
# 启动生产服务器
pnpm start
```

该命令会启动一个 Node.js 服务器来提供构建好的静态文件和 SSR 功能。

## 部署平台

### 1. Vercel 部署（推荐）

项目已针对 Vercel 进行优化配置，部署过程非常简单：

#### 自动部署

1. 将代码推送到 GitHub 仓库
2. 在 Vercel 上导入项目
3. Vercel 会自动检测 Next.js 项目并配置构建设置
4. 每次推送到主分支时自动触发部署

#### 手动部署

1. 安装 Vercel CLI：
   ```bash
   npm install -g vercel
   ```

2. 登录 Vercel：
   ```bash
   vercel login
   ```

3. 部署项目：
   ```bash
   vercel
   ```

#### Vercel 配置要求

在 Vercel 项目设置中需要配置以下内容：

1. **构建命令**: `pnpm build`
2. **输出目录**: `.next`
3. **Node.js 版本**: >= 22.x
4. **环境变量**: 根据 [.env.example](file://c:\project\official\.env.example) 配置必要的环境变量

### 2. 其他平台部署

#### Netlify

1. 在 Netlify 控制台创建新站点
2. 配置构建设置：
   - 构建命令: `pnpm build`
   - 发布目录: `.next`
3. 配置环境变量

#### 自托管服务器

1. 构建项目：
   ```bash
   pnpm build
   ```

2. 将 `.next` 目录和 `public` 目录复制到服务器

3. 在服务器上安装依赖：
   ```bash
   pnpm install --prod
   ```

4. 启动生产服务器：
   ```bash
   pnpm start
   ```

## 环境变量配置

### 1. 必需环境变量

根据 [.env.example](file://c:\project\official\.env.example) 文件，项目需要以下环境变量：

```env
# Clerk 配置
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your_publishable_key_here
CLERK_SECRET_KEY=sk_test_your_secret_key_here

# Clerk 重定向 URL 配置
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/admin
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/admin
```

### 2. 可选环境变量

```env
# 网站配置
NEXT_PUBLIC_SITE_URL=https://your-site-url.com

# 端口配置（开发环境）
PORT=3000
```

## 性能优化

### 1. 构建优化

#### 代码分割

Next.js 自动进行代码分割，但您可以通过以下方式进一步优化：

1. 使用动态导入加载非关键组件：
   ```tsx
   import dynamic from 'next/dynamic';
   
   const HeavyComponent = dynamic(() => import('@/components/heavy-component'));
   ```

2. 预加载关键资源：
   ```tsx
   import { use preload } from 'next/router';
   
   // 在组件中预加载页面
   preload('/critical-page');
   ```

#### 图片优化

项目已配置自动图片优化，使用时应：

1. 使用 Next.js 的 Image 组件：
   ```tsx
   import Image from 'next/image';
   
   <Image 
     src="/images/photo.jpg" 
     alt="描述" 
     width={800} 
     height={600} 
   />
   ```

2. 对于外部图片，确保在 next.config.mjs 中配置了 remotePatterns

### 2. 部署优化

#### CDN 配置

在 Vercel 上部署时，自动获得全球 CDN 加速。在其他平台上，可以：

1. 配置 Cloudflare CDN
2. 使用 AWS CloudFront
3. 配置其他 CDN 服务

#### 缓存策略

项目已配置合理的缓存策略：

1. 静态资源长期缓存
2. API 响应短期缓存
3. 动态内容不缓存

## 监控与分析

### 1. Vercel Analytics

项目可以集成 Vercel Analytics 进行性能监控：

1. 在 Vercel 项目设置中启用 Analytics
2. 安装 @vercel/analytics 包：
   ```bash
   pnpm add @vercel/analytics
   ```

3. 在根布局中添加组件：
   ```tsx
   import { Analytics } from '@vercel/analytics/react';
   
   export default function RootLayout({ children }: { children: React.ReactNode }) {
     return (
       <html>
         <body>
           {children}
           <Analytics />
         </body>
       </html>
     );
   }
   ```

### 2. 错误追踪

可以集成 Sentry 进行错误追踪：

1. 安装 Sentry 包：
   ```bash
   pnpm add @sentry/nextjs
   ```

2. 初始化 Sentry：
   ```bash
   npx @sentry/wizard@latest -i nextjs
   ```

## 故障排除

### 1. 构建失败

#### TypeScript 错误

```bash
# 检查 TypeScript 类型
pnpm type-check
```

#### ESLint 错误

```bash
# 检查代码规范
pnpm lint
```

#### 依赖问题

```bash
# 清理构建文件
pnpm clean

# 重新安装依赖
pnpm install --force
```

### 2. 部署失败

#### 环境变量问题

确保所有必需的环境变量都已正确配置。

#### Node.js 版本问题

确保部署平台的 Node.js 版本 >= 22.x。

#### 构建命令问题

检查构建命令是否正确设置为 `pnpm build`。

### 3. 运行时错误

#### 静态资源加载失败

检查资源路径是否正确，静态资源应放置在 [public/](file://c:\project\official\public) 目录下。

#### API 请求失败

检查 API 路由是否正确实现，确保服务器端代码没有错误。

## 最佳实践

### 1. 构建最佳实践

1. **定期清理构建缓存**：
   ```bash
   pnpm clean
   ```

2. **检查构建产物大小**：
   ```bash
   # 分析构建产物
   pnpm build
   ```

3. **优化图片资源**：
   - 使用 WebP 和 AVIF 格式
   - 合理设置图片尺寸
   - 使用响应式图片

### 2. 部署最佳实践

1. **使用环境变量管理配置**：
   - 不在代码中硬编码敏感信息
   - 为不同环境使用不同的配置

2. **配置 HTTPS**：
   - 在生产环境中强制使用 HTTPS
   - 配置合适的 Content Security Policy

3. **监控和日志**：
   - 配置应用性能监控
   - 设置错误日志收集
   - 配置用户行为分析

### 3. 安全最佳实践

1. **环境变量安全**：
   - 不在代码库中提交敏感环境变量
   - 使用平台提供的密钥管理功能

2. **内容安全策略**：
   - 配置严格的 CSP 头
   - 限制外部资源加载

3. **依赖安全**：
   - 定期更新依赖包
   - 使用 npm audit 或 similar 工具检查安全漏洞

通过遵循这些构建和部署指南，您可以成功地将斐流艺创项目部署到生产环境，并确保其稳定运行。